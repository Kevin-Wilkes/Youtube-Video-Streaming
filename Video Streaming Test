import cv2
import subprocess
import numpy as np
import yt_dlp

url = "https://www.youtube.com/watch?v=73-EekdVVU8"
ydl_opts = {
    "format": "best",
    "quiet": True
}


with yt_dlp.YoutubeDL(ydl_opts) as ydl:
    info_dict = ydl.extract_info(url, download=False)
    stream_url = info_dict.get("url", info_dict["formats"][-1]["url"])

ffmpeg_cmd = [
    "ffmpeg",
    "-i", stream_url,
    "-f", "rawvideo",
    "-pix_fmt", "bgr24",
    "-an",  # no audio
    "-"
]

ffprobe_cmd = [
    r"C:\ffmpeg\bin\ffprobe.exe",
    "-v", "error",
    "-select_streams", "v:0",
    "-show_entries", "stream=width,height",
    "-of", "csv=p=0",
    stream_url
]
proc = subprocess.run(ffprobe_cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)
width, height = map(int, proc.stdout.strip().split('\n')[0].split(','))
frame_size = width * height * 3

pipe = subprocess.Popen(ffmpeg_cmd, stdout=subprocess.PIPE, bufsize=10**8)

while True:
    raw_frame = pipe.stdout.read(frame_size)
    if len(raw_frame) != frame_size:
        break
    frame = np.frombuffer(raw_frame, np.uint8).reshape((height, width, 3))

    cv2.imshow("YouTube Live", frame)
    if cv2.waitKey(1) & 0xFF == ord("q"):
        break
